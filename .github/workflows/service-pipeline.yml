name: Service Pipeline

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Service name (e.g., ide-orchestrator)'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace for deployment'
        required: true
        type: string
      test_names:
        description: 'JSON array of test names (e.g., ["auth", "workflow"])'
        required: true
        type: string
      use_real_llm:
        description: 'Use real LLM for tests (default: main branch only)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  packages: write
  pull-requests: write

jobs:
  # STAGE 1: BUILD
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push
        id: build
        run: |
          chmod +x ./scripts/ci/build.sh
          ./scripts/ci/build.sh

  # STAGE 2: TEST MATRIX
  test:
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test_name: ${{ fromJson(inputs.test_names) }}
    name: test-${{ matrix.test_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Determine Age Key Secret Name
        id: age-key-name
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "name=SOPS_AGE_KEY_DEV" >> $GITHUB_OUTPUT
            echo "env=dev" >> $GITHUB_OUTPUT
          else
            echo "name=SOPS_AGE_KEY_PR" >> $GITHUB_OUTPUT
            echo "env=pr" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout Platform Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/zerotouch-platform
          path: zerotouch-platform
      
      - name: Install SOPS and Age
        run: |
          AGE_VERSION=1.1.1
          curl -Lo age.tar.gz "https://github.com/FiloSottile/age/releases/download/v${AGE_VERSION}/age-v${AGE_VERSION}-linux-amd64.tar.gz"
          tar xf age.tar.gz
          sudo mv age/age age/age-keygen /usr/local/bin/
          
          SOPS_VERSION=3.8.1
          curl -Lo sops "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64"
          chmod +x sops
          sudo mv sops /usr/local/bin/
      
      - name: Decrypt Platform Secrets
        env:
          ENV: ${{ steps.age-key-name.outputs.env }}
          AGE_PRIVATE_KEY: ${{ secrets[steps.age-key-name.outputs.name] }}
        run: |
          cd zerotouch-platform
          ./scripts/bootstrap/infra/secrets/ksops/generate-sops/create-dot-env.sh
          mv .env ../.env
          cd ..
      
      - name: Setup Tenant Environment
        id: setup
        uses: bizmatters/ci-workflow-templates/.github/actions/setup-tenant-env@main
        with:
          service_name: ${{ inputs.service_name }}
          age_key: ${{ secrets[steps.age-key-name.outputs.name] }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull Test Image
        run: docker pull ${{ needs.build.outputs.image_tag }}
      
      - name: Run Integration Test
        env:
          TEST_NAME: ${{ matrix.test_name }}
          TEST_PATH: tests/integration/test_${{ matrix.test_name }}_integration.py
          OVERRIDE_IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
          USE_REAL_LLM: ${{ inputs.use_real_llm || github.ref == 'refs/heads/main' }}
          BOT_GITHUB_TOKEN: ${{ steps.setup.outputs.github_token }}
        run: |
          chmod +x ./scripts/ci/in-cluster-test.sh
          ./scripts/ci/in-cluster-test.sh

  # STAGE 3: RELEASE
  release:
    needs: [build, test]
    if: github.ref == 'refs/heads/main'
    uses: bizmatters/ci-workflow-templates/.github/workflows/release-pipeline.yml@main
    secrets: inherit
    with:
      service_name: ${{ inputs.service_name }}
      image_tag: ${{ needs.build.outputs.image_tag }}
      namespace: ${{ inputs.namespace }}
